<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Greg’s Clock — Stable</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
      color: white;
      background: black;
      overflow: hidden;
    }

    #gradient-bg {
      position: fixed;
      inset: 0;
      z-index: 0;
      background: linear-gradient(to right, rgba(30,60,114,0.6), rgba(42,82,152,0.35));
      background-size: cover;
      background-position: center;
      transition: background-image 1s ease-in-out, background 1s ease-in-out;
    }

    #overlay {
      position: fixed;
      inset: 0;
      z-index: 1;
      background-color: rgba(0,0,0,0.42);
    }

    #content {
      position: relative;
      z-index: 2;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
      box-sizing: border-box;
    }

    .clock-wrap {
      text-align: center;
      user-select: none;
      -webkit-user-select: none;
    }

    #time-main {
      font-weight: 600;
      font-size: clamp(48px, 14vw, 140px);
      line-height: 1;
      text-shadow: 0 2px 10px rgba(0,0,0,0.7);
      display: inline-block;
    }

    #seconds {
      font-size: 0.35em;
      vertical-align: super;
      margin-left: 6px;
      opacity: 0.95;
    }

    #date {
      margin-top: 10px;
      font-size: clamp(16px, 3.2vw, 40px);
      text-shadow: 0 1px 8px rgba(0,0,0,0.6);
    }

    #diag {
      position: fixed;
      top: 12px;
      left: 12px;
      z-index: 9999;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 13px;
      max-width: calc(100% - 160px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #version-badge {
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 9999;
      background: rgba(255,255,255,0.06);
      color: #fff;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 13px;
      border: 1px solid rgba(255,255,255,0.04);
    }
  </style>
</head>
<body>
  <div id="gradient-bg"></div>
  <div id="overlay"></div>

  <div id="content">
    <div class="clock-wrap" aria-live="polite">
      <div id="time-main">--:--<span id="seconds">--</span></div>
      <div id="date">Loading...</div>
    </div>
  </div>

  <div id="diag">Starting...</div>
  <div id="version-badge">v11-stable</div>

  <script>
    (function () {
      // Safe diagnostic setter
      function setDiag(msg) {
        try {
          var d = document.getElementById('diag');
          if (d) d.innerText = msg;
        } catch (e) { /* noop */ }
        try { console.log(msg); } catch (e) { }
      }

      // Global error + promise rejection handlers
      window.addEventListener('error', function (ev) {
        var msg = 'ERROR: ' + (ev && ev.message ? ev.message : JSON.stringify(ev));
        setDiag(msg);
        console.error(ev.error || ev);
      });

      window.addEventListener('unhandledrejection', function (ev) {
        var reason = ev && ev.reason ? ev.reason : 'unhandled rejection';
        setDiag('Promise Rejection: ' + (reason && reason.message ? reason.message : String(reason)));
        console.error(ev);
      });

      try {
        // Elements
        var timeMain = document.getElementById('time-main');
        var secEl = document.getElementById('seconds');
        var dateEl = document.getElementById('date');
        var bgEl = document.getElementById('gradient-bg');

        // Robust clock updater
        function updateClock() {
          try {
            var now = new Date();
            var hrs = now.getHours();
            var minutes = now.getMinutes();
            var seconds = now.getSeconds();

            // Format 12-hour with AM/PM
            var ampm = hrs >= 12 ? 'PM' : 'AM';
            var hrs12 = hrs % 12;
            hrs12 = hrs12 ? hrs12 : 12; // 0 => 12

            var hrsStr = String(hrs12).padStart(2, '0');
            var minStr = String(minutes).padStart(2, '0');
            var secStr = String(seconds).padStart(2, '0');

            // Ensure container elements exist before writing
            if (timeMain) {
              // keep seconds span separate so styling stays intact
              timeMain.firstChild && (timeMain.firstChild.nodeValue = hrsStr + ':' + minStr);
            } else {
              // fallback: attempt to recreate
              var wrap = document.querySelector('.clock-wrap');
              if (wrap) {
                wrap.innerHTML = '<div id="time-main">' + hrsStr + ':' + minStr + '<span id="seconds">' + secStr + '</span></div><div id="date"></div>';
                timeMain = document.getElementById('time-main');
                secEl = document.getElementById('seconds');
                dateEl = document.getElementById('date');
              }
            }

            if (secEl) secEl.textContent = secStr;
            if (dateEl) dateEl.textContent = now.toDateString();

          } catch (err) {
            setDiag('Clock error: ' + (err && err.message ? err.message : String(err)));
            console.error(err);
          }
        }

        // Start clock immediately and every second
        try {
          updateClock();
          setInterval(updateClock, 1000);
        } catch (err) {
          setDiag('Failed to start clock: ' + (err && err.message ? err.message : String(err)));
        }

        // Image loading (non-blocking). No local fallback.
        (function loadBackground() {
          try {
            if (!bgEl) { setDiag('No background element'); return; }

            var pexelsIds = [
              414612, 2014422, 326055, 158607, 34950,
              3156381, 1420706, 247932, 355423, 1108099
            ];

            function pexelsUrlForId(id) {
              return "https://images.pexels.com/photos/" + id + "/pexels-photo-" + id + ".jpeg";
            }

            function getTargetWidth(maxCap) {
              maxCap = maxCap || 1280;
              var w = Math.min(maxCap, Math.round(window.innerWidth || maxCap));
              return Math.max(640, w);
            }

            function buildVariant(url, width, quality) {
              var q = quality || 80;
              return url + "?auto=compress&cs=tinysrgb&dpr=1&w=" + width + "&q=" + q;
            }

            function tryImageSequence(urls, onSuccess, onFail) {
              var i = 0;
              function next() {
                if (i >= urls.length) { onFail(); return; }
                var u = urls[i++];
                setDiag('Trying image: ' + (u.length > 80 ? u.slice(0,80) + '...' : u));
                var t = new Image();
                t.onload = function () { onSuccess(u); };
                t.onerror = function () { next(); };
                // load async
                t.src = u;
              }
              setTimeout(next, 10);
            }

            var id = pexelsIds[Math.floor(Math.random() * pexelsIds.length)];
            var base = pexelsUrlForId(id);
            var w = getTargetWidth(1280);
            var small = buildVariant(base, w, 80);
            var medium = buildVariant(base, Math.min(1920, Math.round(w * 1.25)), 84);
            var original = base;

            tryImageSequence([small, medium, original],
              function (workingUrl) {
                try {
                  setDiag('Loaded background');
                  bgEl.style.backgroundImage = "url('" + workingUrl + "')";
                  bgEl.style.backgroundSize = 'cover';
                  bgEl.style.backgroundPosition = 'center';
                  bgEl.style.backgroundRepeat = 'no-repeat';
                } catch (err) {
                  setDiag('Background set error: ' + (err && err.message ? err.message : String(err)));
                  console.error(err);
                }
              },
              function () {
                setDiag('All image variants failed; keeping gradient');
              }
            );

          } catch (err) {
            setDiag('Image loader error: ' + (err && err.message ? err.message : String(err)));
            console.error(err);
          }
        })();

        // Refresh background every 6 hours
        try {
          setInterval(function () {
            // reload background only (no page reload)
            try {
              // force new random image
              (function refresh() {
                var evt = new Event('refreshBackground');
                window.dispatchEvent(evt);
              })();
            } catch (e) { console.error(e); }
          }, 6 * 60 * 60 * 1000);
        } catch (e) { /* ignore */ }

        setDiag('Running');

      } catch (initErr) {
        setDiag('Init error: ' + (initErr && initErr.message ? initErr.message : String(initErr)));
        console.error(initErr);
      }
    })();
  </script>
</body>
</html>
